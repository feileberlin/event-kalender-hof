name: Feature Guard

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check-features:
    runs-on: ubuntu-latest
    name: Verify Critical Features
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check GoatCounter Analytics
        run: |
          echo "ğŸ” Checking GoatCounter..."
          
          # Check config exists
          if ! grep -q "goatcounter:" _config.yml; then
            echo "âŒ FEHLER: GoatCounter config fehlt in _config.yml"
            exit 1
          fi
          
          # Check correct subdomain code
          if ! grep -q 'code: "feileberlin"' _config.yml; then
            echo "âŒ FEHLER: GoatCounter code ist nicht 'feileberlin'"
            exit 1
          fi
          
          # Check templates exist
          for layout in _layouts/base.html _layouts/map.html _layouts/admin.html; do
            if ! grep -q "site.analytics.goatcounter.code" "$layout"; then
              echo "âŒ FEHLER: GoatCounter template fehlt in $layout"
              exit 1
            fi
          done
          
          echo "âœ… GoatCounter vorhanden und korrekt konfiguriert"
      
      - name: Check Filter System
        run: |
          echo "ğŸ” Checking Filter System..."
          
          # Check category filters config
          if ! grep -q "category_filters:" _config.yml; then
            echo "âŒ FEHLER: category_filters fehlt in _config.yml"
            exit 1
          fi
          
          # Check time filters config
          if ! grep -q "time_filters:" _config.yml; then
            echo "âŒ FEHLER: time_filters fehlt in _config.yml"
            exit 1
          fi
          
          # Check radius filters config
          if ! grep -q "radius_filters:" _config.yml; then
            echo "âŒ FEHLER: radius_filters fehlt in _config.yml"
            exit 1
          fi
          
          # Check filter module exists
          if [ ! -f "assets/js/modules/filters.js" ]; then
            echo "âŒ FEHLER: filters.js fehlt"
            exit 1
          fi
          
          # Check critical filter functions
          if ! grep -q "setCategory" assets/js/modules/filters.js; then
            echo "âŒ FEHLER: setCategory Funktion fehlt in filters.js"
            exit 1
          fi
          
          if ! grep -q "setTime" assets/js/modules/filters.js; then
            echo "âŒ FEHLER: setTime Funktion fehlt in filters.js"
            exit 1
          fi
          
          if ! grep -q "setRadius" assets/js/modules/filters.js; then
            echo "âŒ FEHLER: setRadius Funktion fehlt in filters.js"
            exit 1
          fi
          
          echo "âœ… Filter System vorhanden"
      
      - name: Check RSS Feeds
        run: |
          echo "ğŸ” Checking RSS Feeds..."
          
          # Check feed layouts exist
          for feed in _layouts/feed-all-events.xml _layouts/feed-current-events.xml _layouts/feed-upcoming-events.xml; do
            if [ ! -f "$feed" ]; then
              echo "âŒ FEHLER: $feed fehlt"
              exit 1
            fi
          done
          
          # Check feed pages exist
          for page in feeds/alle-events.xml feeds/aktuelle-events.xml feeds/kommende-events.xml; do
            if [ ! -f "$page" ]; then
              echo "âŒ FEHLER: $page fehlt"
              exit 1
            fi
          done
          
          echo "âœ… RSS Feeds vorhanden"
      
      - name: Check Core JavaScript Modules
        run: |
          echo "ğŸ” Checking JavaScript Modules..."
          
          required_modules=(
            "assets/js/modules/map.js"
            "assets/js/modules/filters.js"
            "assets/js/modules/locationSearch.js"
            "assets/js/modules/eventMarkers.js"
            "assets/js/modules/dateUtils.js"
          )
          
          for module in "${required_modules[@]}"; do
            if [ ! -f "$module" ]; then
              echo "âŒ FEHLER: $module fehlt"
              exit 1
            fi
          done
          
          echo "âœ… Alle Core JS Module vorhanden"
      
      - name: Check Admin Panel
        run: |
          echo "ğŸ” Checking Admin Panel..."
          
          if [ ! -f "admin.html" ]; then
            echo "âŒ FEHLER: admin.html fehlt"
            exit 1
          fi
          
          if [ ! -f "_layouts/admin.html" ]; then
            echo "âŒ FEHLER: _layouts/admin.html fehlt"
            exit 1
          fi
          
          # Check GitHub Meta Editor exists
          if ! grep -q "GitHub Meta Editor" admin.html; then
            echo "âŒ FEHLER: GitHub Meta Editor fehlt in admin.html"
            exit 1
          fi
          
          echo "âœ… Admin Panel vorhanden"
      
      - name: Check Documentation
        run: |
          echo "ğŸ” Checking Documentation..."
          
          required_docs=(
            "README.md"
            "FEATURES.md"
            "TODO.md"
            "INSTALL.md"
            "CODE_OF_CONDUCT.md"
          )
          
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "âŒ FEHLER: $doc fehlt"
              exit 1
            fi
          done
          
          echo "âœ… Alle Dokumentations-Dateien vorhanden"
      
      - name: Summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ¨ Feature Guard Check: SUCCESSFUL âœ¨"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Alle kritischen Features sind vorhanden:"
          echo "  âœ… GoatCounter Analytics"
          echo "  âœ… Filter System (Categories, Time, Radius)"
          echo "  âœ… RSS Feeds (3 Feeds)"
          echo "  âœ… Core JavaScript Modules"
          echo "  âœ… Admin Panel mit GitHub Meta Editor"
          echo "  âœ… Dokumentation (README, FEATURES, TODO)"
          echo ""
