name: Scrape and Review Events

on:
  schedule:
    # Run daily at 6:00 AM UTC (7:00 CET)
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      sources:
        description: 'Sources to scrape (comma-separated, or "all")'
        required: false
        default: 'all'
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  scrape:
    name: Scrape Events
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Run Scraper V2
        id: scrape
        run: |
          python scripts/json_workflow/scraper_v2.py
          
          # Check if staging files were created
          if ls _data/staging/events-*.json 1> /dev/null 2>&1; then
            echo "has_events=true" >> $GITHUB_OUTPUT
            SESSION_ID=$(ls _data/staging/events-*.json | head -1 | sed 's/.*events-\(.*\)\.json/\1/')
            echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
            
            # Count events
            EVENT_COUNT=$(jq '.events | length' "_data/staging/events-$SESSION_ID.json")
            echo "event_count=$EVENT_COUNT" >> $GITHUB_OUTPUT
          else
            echo "has_events=false" >> $GITHUB_OUTPUT
            echo "event_count=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Create review issue
        if: steps.scrape.outputs.has_events == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const sessionId = '${{ steps.scrape.outputs.session_id }}';
            const stagingFile = `_data/staging/events-${sessionId}.json`;
            
            // Load staged events
            const data = JSON.parse(fs.readFileSync(stagingFile, 'utf8'));
            const events = data.events;
            
            // Create issue body
            let body = `## üîç Neue Events zum Review\n\n`;
            body += `**Session:** \`${sessionId}\`\n`;
            body += `**Anzahl:** ${events.length} Event(s)\n`;
            body += `**Gescrapt:** ${data.scraped_at}\n\n`;
            body += `### Events:\n\n`;
            
            events.slice(0, 20).forEach((event, i) => {
              body += `#### ${i + 1}. ${event.title}\n`;
              body += `- üìÖ **Datum:** ${event.start_date}`;
              if (event.start_time) body += ` um ${event.start_time}`;
              body += `\n`;
              body += `- üìç **Ort:** ${event.place}\n`;
              if (event.organizers && event.organizers.length > 0) {
                body += `- üè¢ **Veranstalter:** ${event.organizers.join(', ')}\n`;
              }
              if (event.description && event.description.length > 0) {
                const desc = event.description.substring(0, 150);
                body += `- üìù **Beschreibung:** ${desc}${event.description.length > 150 ? '...' : ''}\n`;
              }
              if (event.meta && event.meta.hash) {
                body += `- üîë **Hash:** \`${event.meta.hash}\`\n`;
              }
              body += `\n`;
            });
            
            if (events.length > 20) {
              body += `\n*... und ${events.length - 20} weitere Events*\n\n`;
            }
            
            body += `\n---\n\n`;
            body += `### üéØ Review-Optionen\n\n`;
            body += `**Option 1: GitHub (Web-Interface)**\n\n`;
            body += `Kommentiere f√ºr jedes Event:\n`;
            body += `- \`/approve <hash>\` - Event genehmigen\n`;
            body += `- \`/reject <hash> [reason]\` - Event ablehnen\n`;
            body += `- \`/merge <hash1> into <hash2>\` - Duplicate zusammenf√ºhren\n\n`;
            body += `Wenn fertig: \`/review-complete\`\n\n`;
            body += `**Option 2: CLI (f√ºr Forks ohne GitHub API)**\n\n`;
            body += `\`\`\`bash\n`;
            body += `python scripts/json_workflow/reviewer.py\n`;
            body += `python scripts/json_workflow/merger.py\n`;
            body += `git add _data/events.json _data/archive/\n`;
            body += `git commit -m "Add reviewed events"\n`;
            body += `git push\n`;
            body += `\`\`\`\n\n`;
            body += `---\n\n`;
            body += `*ü§ñ Automatisch generiert von Scraper V2*`;
            
            // Create issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Review] ${events.length} neue Events - ${sessionId}`,
              body: body,
              labels: ['event-review', 'automated']
            });
            
            console.log(`‚úÖ Created issue #${issue.data.number}`);
      
      - name: Commit staging files
        if: steps.scrape.outputs.has_events == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add _data/staging/
          git commit -m "Add scraped events for review (session ${{ steps.scrape.outputs.session_id }})" || echo "No changes to commit"
          git push

  process-review-commands:
    name: Process Review Commands
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment'
    
    steps:
      - name: Check if review issue
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number
            });
            
            const hasLabel = issue.data.labels.some(l => l.name === 'event-review');
            core.setOutput('is_review_issue', hasLabel ? 'true' : 'false');
            
            const comment = context.payload.comment.body;
            
            // Check for commands
            const hasApprove = /\/approve\s+[a-f0-9]+/.test(comment);
            const hasReject = /\/reject\s+[a-f0-9]+/.test(comment);
            const hasMerge = /\/merge\s+[a-f0-9]+\s+into\s+[a-f0-9]+/.test(comment);
            const hasComplete = /\/review-complete/.test(comment);
            
            core.setOutput('has_command', (hasApprove || hasReject || hasMerge || hasComplete) ? 'true' : 'false');
            core.setOutput('is_complete', hasComplete ? 'true' : 'false');
      
      - name: Record decision
        if: steps.check.outputs.is_review_issue == 'true' && steps.check.outputs.has_command == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const issueNumber = context.payload.issue.number;
            
            // Parse commands
            const approveMatch = comment.match(/\/approve\s+([a-f0-9]+)/g);
            const rejectMatch = comment.match(/\/reject\s+([a-f0-9]+)(?:\s+(.+))?/g);
            const mergeMatch = comment.match(/\/merge\s+([a-f0-9]+)\s+into\s+([a-f0-9]+)/g);
            
            if (approveMatch || rejectMatch || mergeMatch) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '‚úÖ Entscheidung gespeichert. Nutze `/review-complete` um alle √Ñnderungen anzuwenden.'
              });
            }
      
      - name: Trigger merge workflow
        if: steps.check.outputs.is_review_issue == 'true' && steps.check.outputs.is_complete == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            
            // Get session ID from issue title
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const sessionMatch = issue.data.body.match(/Session.*`([^`]+)`/);
            const sessionId = sessionMatch ? sessionMatch[1] : 'unknown';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: 'üîÄ Starte Merge-Prozess...\n\n‚ö†Ô∏è  **Hinweis:** Automatischer Merge via GitHub Actions ist noch nicht implementiert. Bitte nutze CLI:\n\n```bash\npython scripts/json_workflow/merger.py\n```'
            });
            
            // Label issue as reviewed
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['reviewed']
            });

  cli-review-reminder:
    name: CLI Review Reminder
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: scrape
    
    steps:
      - name: Check for pending reviews
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'event-review',
              state: 'open'
            });
            
            if (issues.data.length > 0) {
              console.log(`‚ö†Ô∏è  ${issues.data.length} pending review(s)`);
              
              for (const issue of issues.data) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: '‚è∞ **Reminder:** Dieses Review ist noch offen.\n\nNutze CLI f√ºr lokales Review:\n```bash\npython scripts/json_workflow/reviewer.py\npython scripts/json_workflow/merger.py\n```'
                });
              }
            }
