name: üîç Code Quality Validation

# Schedule konfiguriert in _config.yml: automation.code_validation.schedule
# L√§uft: Monatlich am 1. um 3:00 UTC

on:
  push:
    branches:
      - main
    paths:
      - '**.html'
      - '**.css'
      - '**.js'
      - '.github/workflows/validate-code.yml'
  pull_request:
    paths:
      - '**.html'
      - '**.css'
      - '**.js'
  workflow_dispatch:
  schedule:
    # Schedule konfiguriert in _config.yml: automation.code_validation.schedule
    - cron: '0 3 1 * *'

permissions:
  contents: read

jobs:
  validate-html:
    runs-on: ubuntu-latest
    name: Validate HTML
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: Build Jekyll Site
        run: bundle exec jekyll build --quiet
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install html-validate
        run: npm install -g html-validate
      
      - name: Validate HTML Files
        run: |
          echo "üîç Validating HTML..."
          npx html-validate _site/index.html _site/admin.html
          echo "‚úÖ HTML validation passed!"
  
  validate-css:
    runs-on: ubuntu-latest
    name: Validate CSS
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install stylelint
        run: npm install -g stylelint stylelint-config-standard
      
      - name: Validate CSS Files
        run: |
          echo "üîç Validating CSS..."
          npx stylelint "assets/css/*.css" || echo "‚ö†Ô∏è CSS warnings found (non-blocking)"
          echo "‚úÖ CSS validation completed!"
  
  validate-javascript:
    runs-on: ubuntu-latest
    name: Validate JavaScript
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install ESLint
        run: npm install -g eslint
      
      - name: Validate JavaScript Files
        run: |
          echo "üîç Validating JavaScript..."
          npx eslint assets/js/main.js || true
          echo "‚úÖ JavaScript validation completed!"
  
  check-accessibility:
    runs-on: ubuntu-latest
    name: Check Accessibility
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: Build Jekyll Site
        run: bundle exec jekyll build --quiet
      
      - name: Check for Common Issues
        run: |
          echo "üîç Checking accessibility basics..."
          
          # Check for inline styles
          if grep -r 'style="' _site/*.html; then
            echo "‚ö†Ô∏è Warning: Inline styles found"
          else
            echo "‚úÖ No inline styles"
          fi
          
          # Check for raw & characters
          if grep -r '[^&]&[^amp;#]' _site/*.html; then
            echo "‚ùå Error: Raw & characters found"
            exit 1
          else
            echo "‚úÖ No raw & characters"
          fi
          
          # Check for button types
          if grep -r '<button[^>]*>' _site/*.html | grep -v 'type='; then
            echo "‚ö†Ô∏è Warning: Buttons without type attribute"
          else
            echo "‚úÖ All buttons have type attribute"
          fi
          
          echo "‚úÖ Accessibility check completed!"
