name: ðŸ“š Dokumentations-Regenerierung

on:
  schedule:
    # Jeden Sonntag um 5:00 UTC (konfigurierbar in _config.yml)
    - cron: '0 5 * * 0'
  
  workflow_dispatch:  # Manuell auslÃ¶sbar
    inputs:
      reason:
        description: 'Grund fÃ¼r manuelle Regenerierung'
        required: false
        default: 'Manuelle Aktualisierung'

jobs:
  regenerate:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # FÃ¼r Git-History
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          pip install -r requirements.txt
      
      - name: ðŸ” Lese Konfiguration
        id: config
        run: |
          # Lese Schedule aus _config.yml
          SCHEDULE=$(python3 -c "import yaml; config=yaml.safe_load(open('_config.yml')); print(config.get('automation', {}).get('documentation', {}).get('schedule', '0 5 * * 0'))")
          echo "schedule=$SCHEDULE" >> $GITHUB_OUTPUT
          echo "ðŸ“… Konfigurierter Schedule: $SCHEDULE"
      
      - name: ðŸ“š Regeneriere Dokumentation
        run: |
          echo "ðŸš€ Starte Dokumentations-Regenerierung..."
          python scripts/editorial/regenerate_docs.py
          echo "âœ… Dokumentation erfolgreich regeneriert"
      
      - name: ðŸ“Š Zeige Ã„nderungen
        run: |
          echo "ðŸ“‹ GeÃ¤nderte Dateien:"
          git diff --stat
          
          if [ -n "$(git status --porcelain)" ]; then
            echo "âœ… Es gibt Ã„nderungen zum Committen"
          else
            echo "â„¹ï¸  Keine Ã„nderungen - Dokumentation ist aktuell"
          fi
      
      - name: ðŸ’¾ Commit & Push
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add docs/PROJECT.md README.md
            
            # Commit-Message
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              REASON="${{ github.event.inputs.reason }}"
              git commit -m "ðŸ“š Docs: Regenerierung (manuell)" -m "$REASON"
            else
              git commit -m "ðŸ“š Docs: Automatische Regenerierung" -m "Scheduled update ($(date -u '+%Y-%m-%d %H:%M UTC'))"
            fi
            
            git push
            echo "âœ… Ã„nderungen committed und gepusht"
          else
            echo "â„¹ï¸  Keine Ã„nderungen - Skip Commit"
          fi
      
      - name: ðŸ“ Summary
        if: always()
        run: |
          echo "## ðŸ“š Dokumentations-Regenerierung" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Zeitstempel:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$(git status --porcelain)" ]; then
            echo "### âœ… Ã„nderungen" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            git diff --stat >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸  Keine Ã„nderungen" >> $GITHUB_STEP_SUMMARY
            echo "Dokumentation ist bereits aktuell." >> $GITHUB_STEP_SUMMARY
          fi
