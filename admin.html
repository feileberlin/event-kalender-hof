---
layout: base
title: Admin - Event-Verwaltung
---

<style>
.admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.admin-header {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.admin-header h1 {
    margin: 0 0 10px 0;
}

.admin-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.stat-card {
    background: rgba(255,255,255,0.1);
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}

.stat-number {
    font-size: 32px;
    font-weight: bold;
    display: block;
}

.stat-label {
    font-size: 14px;
    opacity: 0.9;
}

.admin-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 2px solid #dee2e6;
}

.tab-button {
    padding: 12px 24px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    color: #666;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}

.tab-button:hover {
    color: #2c3e50;
}

.tab-button.active {
    color: #2c3e50;
    border-bottom-color: #2c3e50;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.event-admin-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #ffc107;
}

.event-admin-card.published {
    border-left-color: #4caf50;
}

.event-admin-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 15px;
}

.event-admin-title {
    font-size: 20px;
    font-weight: bold;
    color: #2c3e50;
    margin: 0;
}

.event-status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.event-status-badge.draft {
    background: #ffc107;
    color: #000;
}

.event-status-badge.published {
    background: #4caf50;
    color: white;
}

.event-status-badge.archived {
    background: #9e9e9e;
    color: white;
}

.event-admin-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin: 15px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.event-admin-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.btn-edit, .btn-publish, .btn-delete, .btn-preview {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-edit {
    background: #2196f3;
    color: white;
}

.btn-edit:hover {
    background: #1976d2;
}

.btn-publish {
    background: #4caf50;
    color: white;
}

.btn-publish:hover {
    background: #388e3c;
}

.btn-delete {
    background: #f44336;
    color: white;
}

.btn-delete:hover {
    background: #d32f2f;
}

.btn-preview {
    background: #ff9800;
    color: white;
}

.btn-preview:hover {
    background: #f57c00;
}

.edit-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 2000;
    justify-content: center;
    align-items: center;
}

.edit-modal.active {
    display: flex;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 12px;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    width: 90%;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.close-modal {
    font-size: 28px;
    cursor: pointer;
    color: #999;
}

.close-modal:hover {
    color: #333;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #2c3e50;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 10px;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    font-size: 14px;
}

.form-group textarea {
    min-height: 100px;
    resize: vertical;
}

.alert {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.alert-info {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    color: #1565c0;
}

.alert-warning {
    background: #fff3e0;
    border-left: 4px solid #ff9800;
    color: #e65100;
}

.recurring-section {
    background: #f0f4ff;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 2px dashed #2196f3;
}

.recurring-section h4 {
    color: #1565c0;
    margin-top: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px 12px;
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
}

.checkbox-label:hover {
    border-color: #2196f3;
    background: #e3f2fd;
}

.checkbox-label input[type="checkbox"] {
    width: auto;
    margin: 0;
}

.date-list {
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    padding: 10px;
    min-height: 80px;
}

.date-item {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: #2196f3;
    color: white;
    padding: 5px 10px;
    border-radius: 20px;
    margin: 3px;
    font-size: 13px;
}

.date-item .remove-date {
    cursor: pointer;
    font-weight: bold;
    margin-left: 5px;
}

.date-item .remove-date:hover {
    color: #ffeb3b;
}

.preview-section {
    background: #fff9e6;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
    border-left: 4px solid #ff9800;
}

.preview-section h4 {
    color: #e65100;
    margin-top: 0;
}

.preview-dates {
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 2px solid #ffb74d;
    border-radius: 6px;
    padding: 15px;
}

.preview-date-item {
    padding: 8px;
    margin: 5px 0;
    background: #fff3e0;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.preview-date-item.regular {
    border-left: 3px solid #4caf50;
}

.preview-date-item.addition {
    border-left: 3px solid #2196f3;
    font-weight: 600;
}

.preview-date-item.exception {
    border-left: 3px solid #f44336;
    opacity: 0.6;
    text-decoration: line-through;
}

.btn-add-date {
    background: #4caf50;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    margin-top: 10px;
}

.btn-add-date:hover {
    background: #388e3c;
}

.btn-generate-preview {
    background: #ff9800;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    margin-top: 15px;
}

.btn-generate-preview:hover {
    background: #f57c00;
}

/* Duplicate Cluster Styles */
.cluster-card {
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.cluster-card.high-confidence {
    border-left: 4px solid #4caf50;
}

.cluster-card.medium-confidence {
    border-left: 4px solid #ff9800;
}

.cluster-card.low-confidence {
    border-left: 4px solid #f44336;
}

.cluster-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 15px;
}

.cluster-title {
    font-size: 20px;
    font-weight: bold;
    color: #2c3e50;
}

.confidence-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.confidence-badge.high {
    background: #4caf50;
    color: white;
}

.confidence-badge.medium {
    background: #ff9800;
    color: white;
}

.confidence-badge.low {
    background: #f44336;
    color: white;
}

.cluster-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin-bottom: 15px;
}

.cluster-meta-item {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
}

.cluster-meta-item strong {
    display: block;
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
}

.source-links {
    background: #e3f2fd;
    border: 1px solid #2196f3;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
}

.source-links h4 {
    margin: 0 0 10px 0;
    color: #1976d2;
    font-size: 14px;
}

.source-link-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(33, 150, 243, 0.2);
}

.source-link-item:last-child {
    border-bottom: none;
}

.source-link-item a {
    color: #2196f3;
    text-decoration: none;
    font-weight: 500;
}

.source-link-item a:hover {
    text-decoration: underline;
}

.data-quality-bar {
    background: #e0e0e0;
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 5px;
}

.data-quality-fill {
    height: 100%;
    background: linear-gradient(90deg, #f44336 0%, #ff9800 50%, #4caf50 100%);
    transition: width 0.3s;
}

.cluster-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.btn-merge {
    background: #4caf50;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
}

.btn-merge:hover {
    background: #388e3c;
}

.btn-split {
    background: #ff9800;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
}

.btn-split:hover {
    background: #f57c00;
}

.btn-ignore {
    background: #9e9e9e;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
}

.btn-ignore:hover {
    background: #757575;
}
</style>

<div class="admin-container">
    <div class="admin-header">
        <h1>üîß Admin-Bereich</h1>
        <p>Event-Verwaltung f√ºr Hof an der Saale</p>
        
        <div class="admin-stats">
            <div class="stat-card">
                <span class="stat-number" id="stat-total">0</span>
                <span class="stat-label">Gesamt Events</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="stat-drafts">0</span>
                <span class="stat-label">Entw√ºrfe</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="stat-published">0</span>
                <span class="stat-label">Ver√∂ffentlicht</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="stat-archived">0</span>
                <span class="stat-label">Archiviert</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="stat-upcoming">0</span>
                <span class="stat-label">Kommende</span>
            </div>
        </div>
    </div>

    <div class="alert alert-warning">
        <strong>‚ö†Ô∏è Hinweis:</strong> Dies ist eine vereinfachte Admin-Oberfl√§che. 
        F√ºr vollst√§ndige Event-Bearbeitung √∂ffne die Markdown-Dateien direkt im Repository 
        unter <code>_events/</code> oder nutze die GitHub Web-Oberfl√§che.
    </div>

    <div class="admin-tabs">
        <button class="tab-button active" onclick="switchTab('drafts')">üìù Entw√ºrfe</button>
        <button class="tab-button" onclick="switchTab('duplicates')">üîÑ Duplikate</button>
        <button class="tab-button" onclick="switchTab('published')">‚úì Ver√∂ffentlicht</button>
        <button class="tab-button" onclick="switchTab('archived')">üì¶ Archiviert</button>
        <button class="tab-button" onclick="switchTab('all')">üìã Alle Events</button>
        <button class="tab-button" onclick="switchTab('create')">‚ûï Neues Event</button>
    </div>

    <div id="tab-drafts" class="tab-content active">
        <h2>Entw√ºrfe zur √úberpr√ºfung</h2>
        <div id="drafts-list"></div>
    </div>

    <div id="tab-duplicates" class="tab-content">
        <h2>üîÑ Duplikate & Enrichment</h2>
        <p style="color: #666; margin-bottom: 20px;">
            ü§ñ Diese Events wurden auf mehreren Quellen gefunden. Pr√ºfe die Daten und merge sie zu einem kanonischen Event.<br>
            <strong>Confidence Score:</strong> Wie sicher das System ist, dass es dasselbe Event ist.
        </p>
        <div id="duplicates-list"></div>
    </div>

    <div id="tab-published" class="tab-content">
        <h2>Ver√∂ffentlichte Events</h2>
        <div id="published-list"></div>
    </div>

    <div id="tab-archived" class="tab-content">
        <h2>Archivierte Events</h2>
        <p style="color: #666; margin-bottom: 20px;">
            üì¶ Archivierte Events werden nicht mehr auf der Hauptseite angezeigt.<br>
            Sie befinden sich in <code>_events/_history/JAHR/</code> (z.B. <code>_history/2025/</code>)
        </p>
        <div id="archived-list"></div>
    </div>

    <div id="tab-all" class="tab-content">
        <h2>Alle Events</h2>
        <div id="all-list"></div>
    </div>

    <div id="tab-create" class="tab-content">
        <h2>‚ûï Neues Event erstellen</h2>
        
        <div class="alert alert-info">
            <strong>‚ÑπÔ∏è Info:</strong> Dieses Formular generiert den Markdown-Code f√ºr ein neues Event. 
            Kopiere den generierten Code und erstelle eine neue Datei in <code>_events/</code>.
        </div>

        <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div class="form-group">
                <label>Event-Titel *</label>
                <input type="text" id="new-title" placeholder="z.B. Stammtisch Kulturfreunde">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Startdatum *</label>
                    <input type="date" id="new-date">
                </div>
                <div class="form-group">
                    <label>Startzeit</label>
                    <input type="time" id="new-start-time">
                </div>
                <div class="form-group">
                    <label>Endzeit</label>
                    <input type="time" id="new-end-time">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Ort *</label>
                    <input type="text" id="new-location" placeholder="z.B. Freiheitshalle Hof">
                </div>
                <div class="form-group">
                    <label>Kategorie</label>
                    <select id="new-category">
                        <option value="">Bitte w√§hlen</option>
                        <option value="Musik">Musik</option>
                        <option value="Kultur">Kultur</option>
                        <option value="Sport">Sport</option>
                        <option value="Familie">Familie</option>
                        <option value="Bildung">Bildung</option>
                        <option value="Sonstiges">Sonstiges</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Beschreibung</label>
                <textarea id="new-description" placeholder="Kurze Beschreibung des Events..."></textarea>
            </div>

            <!-- Recurring Events Section -->
            <div class="recurring-section">
                <h4>üîÑ Wiederkehrendes Event</h4>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="new-recurring-enabled" onchange="toggleRecurringOptions()">
                        <span>Als wiederkehrendes Event konfigurieren</span>
                    </label>
                </div>

                <div id="recurring-options" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Wiederholung *</label>
                            <select id="new-recurring-frequency" onchange="updateRecurringUI()">
                                <option value="daily">T√§glich</option>
                                <option value="weekly">W√∂chentlich</option>
                                <option value="monthly">Monatlich</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Intervall</label>
                            <input type="number" id="new-recurring-interval" value="1" min="1" placeholder="z.B. 2 = alle 2 Wochen">
                        </div>
                        <div class="form-group">
                            <label>Enddatum</label>
                            <input type="date" id="new-recurring-end-date" placeholder="Leer = unbegrenzt">
                        </div>
                    </div>

                    <div class="form-group" id="by-day-section">
                        <label>Wochentag(e)</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" value="MO"> Montag
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="TU"> Dienstag
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="WE"> Mittwoch
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="TH"> Donnerstag
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="FR"> Freitag
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="SA"> Samstag
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="SU"> Sonntag
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="by-set-pos-section" style="display: none;">
                        <label>Position im Monat (N-ter Wochentag)</label>
                        <select id="new-recurring-by-set-pos">
                            <option value="">Alle Wochentage</option>
                            <option value="1">Erster (z.B. erster Freitag)</option>
                            <option value="2">Zweiter (z.B. zweiter Dienstag)</option>
                            <option value="3">Dritter</option>
                            <option value="4">Vierter</option>
                            <option value="5">F√ºnfter</option>
                            <option value="-1">Letzter (z.B. letzter Sonntag)</option>
                            <option value="-2">Vorletzter</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>üö´ Ausnahmen (Termine ausschlie√üen)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="date" id="new-exception-date">
                            <button class="btn-add-date" onclick="addException()">+ Hinzuf√ºgen</button>
                        </div>
                        <div id="exceptions-list" class="date-list"></div>
                    </div>

                    <div class="form-group">
                        <label>‚≠ê Zusatztermine (Extra-Events)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="date" id="new-addition-date">
                            <button class="btn-add-date" onclick="addAddition()">+ Hinzuf√ºgen</button>
                        </div>
                        <div id="additions-list" class="date-list"></div>
                    </div>

                    <button class="btn-generate-preview" onclick="generatePreview()">
                        üëÅÔ∏è Vorschau generieren (10 Termine)
                    </button>

                    <div id="preview-container" class="preview-section" style="display: none;">
                        <h4>üìÖ Vorschau der generierten Termine</h4>
                        <div id="preview-output" class="preview-dates"></div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 30px; display: flex; gap: 15px;">
                <button class="btn-publish" onclick="generateMarkdown()" style="flex: 1;">
                    üìÑ Markdown generieren
                </button>
                <button class="btn-edit" onclick="resetForm()">
                    üîÑ Formular zur√ºcksetzen
                </button>
            </div>

            <div id="markdown-output" style="display: none; margin-top: 30px;">
                <h3>üìÑ Generierter Markdown-Code</h3>
                <div class="alert alert-info">
                    <strong>N√§chste Schritte:</strong>
                    <ol style="margin: 10px 0 0 20px;">
                        <li>Kopiere den unten stehenden Code</li>
                        <li>Erstelle eine neue Datei: <code>_events/YYYY-MM-DD-slug.md</code></li>
                        <li>F√ºge den Code ein und committe die √Ñnderung</li>
                    </ol>
                </div>
                <textarea id="markdown-code" style="width: 100%; min-height: 400px; font-family: monospace; font-size: 13px; padding: 15px; border: 2px solid #2196f3; border-radius: 8px;"></textarea>
                <button class="btn-publish" onclick="copyMarkdown()" style="margin-top: 10px;">
                    üìã In Zwischenablage kopieren
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="edit-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Event bearbeiten</h2>
            <span class="close-modal" onclick="closeModal()">&times;</span>
        </div>
        
        <div class="alert alert-info">
            <strong>‚ÑπÔ∏è Info:</strong> √Ñnderungen werden als GitHub Issue vorgeschlagen, 
            da direkte Dateibearbeitung aus dem Browser nur mit GitHub API m√∂glich ist.
        </div>
        
        <div id="editForm">
            <!-- Wird dynamisch gef√ºllt -->
        </div>
    </div>
</div>

<script>
// Alle Events aus Jekyll laden
const allEvents = [
    {% for event in site.events %}
    {
        title: {{ event.title | jsonify }},
        date: "{{ event.date | date: '%Y-%m-%d' }}",
        startTime: "{{ event.start_time }}",
        endTime: "{{ event.end_time }}",
        location: {{ event.location | jsonify }},
        category: {{ event.category | jsonify }},
        description: {{ event.description | jsonify }},
        status: {{ event.status | jsonify }},
        source: {{ event.source | jsonify }},
        url: "{{ event.url | relative_url }}",
        filename: "{{ event.path | split: '/' | last }}",
        recurring: {{ event.recurring | jsonify }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
];

// Recurring Event Helper Functions
const WEEKDAY_MAP = {
    'MO': 'Montag',
    'TU': 'Dienstag', 
    'WE': 'Mittwoch',
    'TH': 'Donnerstag',
    'FR': 'Freitag',
    'SA': 'Samstag',
    'SU': 'Sonntag'
};

const FREQUENCY_MAP = {
    'daily': 'T√§glich',
    'weekly': 'W√∂chentlich',
    'monthly': 'Monatlich'
};

const POSITION_MAP = {
    1: 'Ersten',
    2: 'Zweiten',
    3: 'Dritten',
    4: 'Vierten',
    5: 'F√ºnften',
    '-1': 'Letzten',
    '-2': 'Vorletzten'
};

function generateRecurringInstances(event, maxInstances = 10) {
    if (!event.recurring || !event.recurring.enabled) {
        return [{ date: event.date, type: 'regular' }];
    }
    
    const r = event.recurring;
    const instances = [];
    const startDate = new Date(r.start_date || event.date);
    const endDate = r.end_date ? new Date(r.end_date) : new Date(startDate.getTime() + 120 * 24 * 60 * 60 * 1000);
    const exceptions = new Set(r.exceptions || []);
    const additions = r.additions || [];
    
    let currentDate = new Date(startDate);
    const interval = r.interval || 1;
    
    // Regul√§re Instanzen generieren
    while (currentDate <= endDate && instances.filter(i => i.type !== 'exception').length < maxInstances) {
        let shouldAdd = false;
        
        if (r.frequency === 'daily') {
            shouldAdd = true;
        } else if (r.frequency === 'weekly' && r.by_day) {
            const weekday = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'][currentDate.getDay()];
            shouldAdd = r.by_day.includes(weekday);
        } else if (r.frequency === 'monthly' && r.by_day) {
            const weekday = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'][currentDate.getDay()];
            if (r.by_day.includes(weekday)) {
                if (r.by_set_pos) {
                    shouldAdd = isNthWeekdayInMonth(currentDate, r.by_set_pos);
                } else {
                    shouldAdd = true;
                }
            }
        }
        
        const dateStr = currentDate.toISOString().split('T')[0];
        if (shouldAdd) {
            if (exceptions.has(dateStr)) {
                instances.push({ date: dateStr, type: 'exception' });
            } else {
                instances.push({ date: dateStr, type: 'regular' });
            }
        }
        
        // N√§chstes Datum
        if (r.frequency === 'daily') {
            currentDate.setDate(currentDate.getDate() + interval);
        } else if (r.frequency === 'weekly') {
            currentDate.setDate(currentDate.getDate() + 1);
        } else if (r.frequency === 'monthly') {
            currentDate.setDate(currentDate.getDate() + 1);
        }
    }
    
    // Additions hinzuf√ºgen
    additions.forEach(dateStr => {
        if (!instances.find(i => i.date === dateStr)) {
            instances.push({ date: dateStr, type: 'addition' });
        }
    });
    
    // Sortieren
    instances.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    return instances;
}

function isNthWeekdayInMonth(date, position) {
    const year = date.getFullYear();
    const month = date.getMonth();
    const weekday = date.getDay();
    
    if (position > 0) {
        // Positive Position (1-5)
        let count = 0;
        for (let day = 1; day <= date.getDate(); day++) {
            const testDate = new Date(year, month, day);
            if (testDate.getDay() === weekday) {
                count++;
            }
        }
        return count === position;
    } else {
        // Negative Position (-1 bis -5)
        const lastDay = new Date(year, month + 1, 0).getDate();
        let count = 0;
        for (let day = lastDay; day >= date.getDate(); day--) {
            const testDate = new Date(year, month, day);
            if (testDate.getDay() === weekday) {
                count++;
            }
        }
        return count === Math.abs(position);
    }
}

function formatRecurringInfo(event) {
    if (!event.recurring || !event.recurring.enabled) {
        return 'üìÖ Einzeltermin';
    }
    
    const r = event.recurring;
    let info = 'üîÑ ';
    
    if (r.frequency === 'weekly' && r.by_day) {
        const days = r.by_day.map(d => WEEKDAY_MAP[d] || d).join(' + ');
        info += `Jeden ${days}`;
    } else if (r.frequency === 'monthly' && r.by_day && r.by_set_pos) {
        const day = WEEKDAY_MAP[r.by_day[0]];
        const pos = POSITION_MAP[r.by_set_pos];
        info += `Jeden ${pos} ${day} im Monat`;
    } else {
        info += FREQUENCY_MAP[r.frequency] || r.frequency;
    }
    
    if (r.exceptions && r.exceptions.length > 0) {
        info += ` (${r.exceptions.length} Ausnahmen)`;
    }
    if (r.additions && r.additions.length > 0) {
        info += ` + ${r.additions.length} Zusatztermine`;
    }
    
    return info;
}


// Statistiken berechnen
function calculateStats() {
    const now = new Date();
    const drafts = allEvents.filter(e => e.status === 'Entwurf');
    const published = allEvents.filter(e => e.status === '√ñffentlich');
    const archived = allEvents.filter(e => e.status === 'Archiviert');
    const upcoming = allEvents.filter(e => {
        const eventDate = new Date(e.date + 'T' + (e.startTime || '00:00'));
        return eventDate >= now;
    });
    
    document.getElementById('stat-total').textContent = allEvents.length;
    document.getElementById('stat-drafts').textContent = drafts.length;
    document.getElementById('stat-published').textContent = published.length;
    document.getElementById('stat-archived').textContent = archived.length;
    document.getElementById('stat-upcoming').textContent = upcoming.length;
}

// Events anzeigen
function displayEvents(filter = 'all') {
    let events = allEvents;
    
    if (filter === 'drafts') {
        events = events.filter(e => e.status === 'Entwurf');
    } else if (filter === 'published') {
        events = events.filter(e => e.status === '√ñffentlich');
    } else if (filter === 'archived') {
        events = events.filter(e => e.status === 'Archiviert');
    }
    
    // Nach Datum sortieren
    events.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    const listId = filter === 'all' ? 'all-list' : 
                   filter === 'drafts' ? 'drafts-list' : 
                   filter === 'published' ? 'published-list' : 'archived-list';
    const container = document.getElementById(listId);
    
    if (events.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Keine Events gefunden.</p>';
        return;
    }
    
    container.innerHTML = events.map(event => `
        <div class="event-admin-card ${event.status === '√ñffentlich' ? 'published' : ''}">
            <div class="event-admin-header">
                <h3 class="event-admin-title">${event.title}</h3>
                <span class="event-status-badge ${event.status === 'Entwurf' ? 'draft' : event.status === 'Archiviert' ? 'archived' : 'published'}">
                    ${event.status}
                </span>
            </div>
            
            <div class="event-admin-meta">
                <div><strong>üìÖ Datum:</strong> ${new Date(event.date).toLocaleDateString('de-DE')}</div>
                <div><strong>üïê Zeit:</strong> ${event.startTime || 'N/A'}</div>
                <div><strong>üìç Ort:</strong> ${event.location}</div>
                <div><strong>üè∑Ô∏è Kategorie:</strong> ${event.category || 'N/A'}</div>
                <div><strong>üì¶ Quelle:</strong> ${event.source || 'Manuell'}</div>
                <div style="grid-column: 1/-1;"><strong>${formatRecurringInfo(event)}</strong></div>
            </div>
            
            <p><strong>Beschreibung:</strong> ${event.description || 'Keine Beschreibung'}</p>
            
            ${event.recurring && event.recurring.enabled ? `
                <div class="preview-section" style="margin: 15px 0;">
                    <h4 style="margin: 0 0 10px 0;">üîÑ Kommende Termine (Vorschau)</h4>
                    <div class="preview-dates" style="padding: 10px; max-height: 150px;">
                        ${generateRecurringInstances(event, 10).map((inst, idx) => `
                            <div class="preview-date-item ${inst.type}">
                                ${inst.type === 'addition' ? '‚≠ê' : inst.type === 'exception' ? '‚ùå' : 'üìå'} 
                                ${idx + 1}. ${new Date(inst.date).toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' })}
                                ${inst.type === 'addition' ? ' (ZUSATZTERMIN)' : inst.type === 'exception' ? ' (AUSNAHME)' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <div class="event-admin-actions">
                <button class="btn-preview" onclick="window.open('${event.url}', '_blank')">
                    üëÅÔ∏è Vorschau
                </button>
                <button class="btn-edit" onclick="editEvent('${event.filename}')">
                    ‚úèÔ∏è Bearbeiten (GitHub)
                </button>
                ${event.status === 'Entwurf' ? 
                    `<button class="btn-publish" onclick="publishEvent('${event.filename}')">
                        ‚úì Publizieren
                    </button>
                    <button class="btn-delete" onclick="deleteEvent('${event.filename}')">
                        üóëÔ∏è L√∂schen
                    </button>` : 
                    `<button class="btn-delete" onclick="archiveEvent('${event.filename}')">
                        üì¶ Archivieren
                    </button>`}
            </div>
        </div>
    `).join('');
}

// Tabs wechseln
function switchTab(tab) {
    // Tab-Buttons aktualisieren
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Tab-Content aktualisieren
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    
    // Events anzeigen
    if (tab === 'duplicates') {
        loadDuplicates();
    } else {
        displayEvents(tab);
    }
}

// Duplikate laden und anzeigen
async function loadDuplicates() {
    const container = document.getElementById('duplicates-list');
    container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Lade Duplikate...</p></div>';
    
    try {
        // Versuche admin_review_queue.json zu laden
        const response = await fetch('{{ site.baseurl }}/assets/data/admin_review_queue.json');
        
        if (!response.ok) {
            throw new Error('Review-Queue nicht gefunden');
        }
        
        const reviewData = await response.json();
        
        if (reviewData.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; background: white; border-radius: 12px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚úÖ</div>
                    <h3>Keine Duplikate gefunden</h3>
                    <p style="color: #666;">Alle Events sind eindeutig oder wurden bereits bearbeitet.</p>
                    <p style="margin-top: 20px;"><code>python3 scripts/deduplication_engine.py</code></p>
                </div>
            `;
            return;
        }
        
        // Sortiere nach Confidence (niedrigste zuerst - ben√∂tigen Review)
        reviewData.sort((a, b) => a.confidence - b.confidence);
        
        container.innerHTML = reviewData.map(cluster => renderClusterCard(cluster)).join('');
        
    } catch (error) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; background: #fff3cd; border-radius: 12px; border: 2px solid #ffc107;">
                <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                <h3>Review-Queue noch nicht generiert</h3>
                <p style="color: #666;">F√ºhre den Deduplication-Scan aus:</p>
                <pre style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 20px 0; text-align: left;">cd /workspaces/event-kalender-hof
python3 scripts/deduplication_engine.py</pre>
                <p style="color: #666;">Dies erstellt die Datei <code>_data/admin_review_queue.json</code></p>
            </div>
        `;
    }
}

// Render Cluster Card
function renderClusterCard(cluster) {
    const confidenceClass = cluster.confidence >= 0.9 ? 'high' : cluster.confidence >= 0.7 ? 'medium' : 'low';
    const confidenceLabel = cluster.confidence >= 0.9 ? 'Hoch' : cluster.confidence >= 0.7 ? 'Mittel' : 'Niedrig';
    
    const qualityPercent = Math.round(cluster.data_quality_score * 100);
    
    // Format date
    const eventDate = new Date(cluster.date + 'T12:00:00');
    const dateStr = eventDate.toLocaleDateString('de-DE', { weekday: 'short', year: 'numeric', month: 'long', day: 'numeric' });
    
    return `
        <div class="cluster-card ${confidenceClass}-confidence">
            <div class="cluster-header">
                <div>
                    <div class="cluster-title">${cluster.title}</div>
                    <div style="color: #666; margin-top: 5px;">
                        üìÖ ${dateStr} | üìç ${cluster.location}
                    </div>
                </div>
                <span class="confidence-badge ${confidenceClass}">
                    ${confidenceLabel}: ${Math.round(cluster.confidence * 100)}%
                </span>
            </div>
            
            <div class="cluster-meta">
                <div class="cluster-meta-item">
                    <strong>Duplikate gefunden</strong>
                    ${cluster.duplicate_count} Quellen
                </div>
                <div class="cluster-meta-item">
                    <strong>Cluster ID</strong>
                    ${cluster.cluster_id}
                </div>
                <div class="cluster-meta-item">
                    <strong>Datenqualit√§t</strong>
                    ${qualityPercent}%
                    <div class="data-quality-bar">
                        <div class="data-quality-fill" style="width: ${qualityPercent}%"></div>
                    </div>
                </div>
                <div class="cluster-meta-item">
                    <strong>Review n√∂tig?</strong>
                    ${cluster.requires_review ? '‚ö†Ô∏è Ja' : '‚úÖ Nein'}
                </div>
            </div>
            
            <div class="source-links">
                <h4>üîó Gefunden auf folgenden Quellen:</h4>
                ${cluster.source_links.map(link => `
                    <div class="source-link-item">
                        <span><strong>${link.source}</strong> (${link.scraped_at})</span>
                        <a href="${link.url}" target="_blank" rel="noopener">Quelle √∂ffnen ‚Üó</a>
                    </div>
                `).join('')}
            </div>
            
            ${cluster.canonical_data.description ? `
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <strong>Beschreibung (merged):</strong>
                    <p style="margin: 10px 0 0 0; color: #666;">${cluster.canonical_data.description.substring(0, 300)}${cluster.canonical_data.description.length > 300 ? '...' : ''}</p>
                </div>
            ` : ''}
            
            <div class="cluster-actions">
                <button class="btn-merge" onclick="mergeCluster('${cluster.cluster_id}')">
                    ‚úÖ Merge & Publizieren
                </button>
                <button class="btn-split" onclick="splitCluster('${cluster.cluster_id}')">
                    ‚úÇÔ∏è Aufteilen (kein Duplikat)
                </button>
                <button class="btn-ignore" onclick="ignoreCluster('${cluster.cluster_id}')">
                    üö´ Ignorieren
                </button>
                <button class="btn-edit" onclick="viewClusterDetails('${cluster.cluster_id}')">
                    üìù Details anzeigen
                </button>
            </div>
        </div>
    `;
}

// Cluster-Aktionen
function mergeCluster(clusterId) {
    if (confirm(`Cluster ${clusterId} mergen und als kanonisches Event ver√∂ffentlichen?\n\nDies erstellt ein Event mit den besten Daten aus allen Quellen.`)) {
        alert(`TODO: API-Aufruf zum Mergen\n\nAktuell: √ñffne die Datei _data/admin_review_queue.json und kopiere das canonical_data f√ºr diesen Cluster.`);
        // TODO: Implementiere API-Aufruf oder GitHub Action
    }
}

function splitCluster(clusterId) {
    if (confirm(`Cluster ${clusterId} aufteilen?\n\nDies markiert die Events als unterschiedlich (kein Duplikat).`)) {
        alert(`TODO: API-Aufruf zum Aufteilen\n\nDies w√ºrde die Events aus dem Cluster entfernen und separat behandeln.`);
        // TODO: Implementiere API-Aufruf
    }
}

function ignoreCluster(clusterId) {
    if (confirm(`Cluster ${clusterId} ignorieren?\n\nDies entfernt den Cluster aus der Review-Queue.`)) {
        alert(`TODO: API-Aufruf zum Ignorieren\n\nDer Cluster wird als "reviewed" markiert.`);
        // TODO: Implementiere API-Aufruf
    }
}

function viewClusterDetails(clusterId) {
    alert(`TODO: Detailansicht f√ºr Cluster ${clusterId}\n\nZeigt alle einzelnen Events mit Unterschieden.`);
    // TODO: Modal mit vollst√§ndigen Daten
}

// Event bearbeiten (zu GitHub weiterleiten)
function editEvent(filename) {
    const repoUrl = 'https://github.com/feileberlin/event-kalender-hof';
    const editUrl = `${repoUrl}/edit/main/_events/${filename}`;
    window.open(editUrl, '_blank');
}

// Event publizieren
function publishEvent(filename) {
    if (confirm(`Event "${filename}" wirklich ver√∂ffentlichen?\n\nDies √§ndert den Status von "Entwurf" auf "√ñffentlich".`)) {
        alert(`Um das Event zu publizieren, √∂ffne die Datei _events/${filename} und √§ndere:\n\nstatus: "Entwurf"\n‚Üí\nstatus: "√ñffentlich"\n\nDann committe und pushe die √Ñnderung.`);
        editEvent(filename);
    }
}

// Event l√∂schen (nur f√ºr Entw√ºrfe)
function deleteEvent(filename) {
    if (confirm(`Entwurf "${filename}" wirklich l√∂schen?\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden!`)) {
        alert(`Um den Entwurf zu l√∂schen, entferne die Datei _events/${filename} aus dem Repository und committe die √Ñnderung.`);
        const repoUrl = 'https://github.com/feileberlin/event-kalender-hof';
        window.open(`${repoUrl}/tree/main/_events`, '_blank');
    }
}

// Event archivieren (f√ºr ver√∂ffentlichte Events)
function archiveEvent(filename) {
    if (confirm(`Event "${filename}" archivieren?\n\nArchivierte Events werden nicht mehr angezeigt, bleiben aber im Repository erhalten.`)) {
        alert(`Um das Event zu archivieren:\n\n1. √ñffne die Datei _events/${filename} auf GitHub\n2. √Ñndere status: "√ñffentlich" zu status: "Archiviert"\n3. Committe die √Ñnderung\n\nDas Event wird dann nicht mehr auf der Website angezeigt.`);
        const repoUrl = 'https://github.com/feileberlin/event-kalender-hof';
        window.open(`${repoUrl}/edit/main/_events/${filename}`, '_blank');
    }
}

// Modal schlie√üen
function closeModal() {
    document.getElementById('editModal').classList.remove('active');
}

// Initialisierung
document.addEventListener('DOMContentLoaded', function() {
    calculateStats();
    displayEvents('drafts');
});

// Recurring Event Form Management
let exceptionsData = [];
let additionsData = [];

function toggleRecurringOptions() {
    const enabled = document.getElementById('new-recurring-enabled').checked;
    document.getElementById('recurring-options').style.display = enabled ? 'block' : 'none';
    if (enabled) updateRecurringUI();
}

function updateRecurringUI() {
    const frequency = document.getElementById('new-recurring-frequency').value;
    const byDaySection = document.getElementById('by-day-section');
    const bySetPosSection = document.getElementById('by-set-pos-section');
    
    if (frequency === 'weekly') {
        byDaySection.style.display = 'block';
        bySetPosSection.style.display = 'none';
    } else if (frequency === 'monthly') {
        byDaySection.style.display = 'block';
        bySetPosSection.style.display = 'block';
    } else {
        byDaySection.style.display = 'none';
        bySetPosSection.style.display = 'none';
    }
}

function addException() {
    const dateInput = document.getElementById('new-exception-date');
    const date = dateInput.value;
    if (!date) {
        alert('Bitte w√§hle ein Datum aus.');
        return;
    }
    if (exceptionsData.includes(date)) {
        alert('Dieses Datum ist bereits als Ausnahme markiert.');
        return;
    }
    exceptionsData.push(date);
    exceptionsData.sort();
    renderDateList('exceptions-list', exceptionsData, 'removeException');
    dateInput.value = '';
}

function removeException(date) {
    exceptionsData = exceptionsData.filter(d => d !== date);
    renderDateList('exceptions-list', exceptionsData, 'removeException');
}

function addAddition() {
    const dateInput = document.getElementById('new-addition-date');
    const date = dateInput.value;
    if (!date) {
        alert('Bitte w√§hle ein Datum aus.');
        return;
    }
    if (additionsData.includes(date)) {
        alert('Dieses Datum ist bereits als Zusatztermin markiert.');
        return;
    }
    additionsData.push(date);
    additionsData.sort();
    renderDateList('additions-list', additionsData, 'removeAddition');
    dateInput.value = '';
}

function removeAddition(date) {
    additionsData = additionsData.filter(d => d !== date);
    renderDateList('additions-list', additionsData, 'removeAddition');
}

function renderDateList(containerId, dates, removeFunction) {
    const container = document.getElementById(containerId);
    if (dates.length === 0) {
        container.innerHTML = '<div style="color: #999; padding: 10px; text-align: center;">Keine Eintr√§ge</div>';
        return;
    }
    container.innerHTML = dates.map(date => `
        <div class="date-item">
            ${new Date(date + 'T12:00:00').toLocaleDateString('de-DE')}
            <span class="remove-date" onclick="${removeFunction}('${date}')">‚úï</span>
        </div>
    `).join('');
}

function generatePreview() {
    const recurringEnabled = document.getElementById('new-recurring-enabled').checked;
    if (!recurringEnabled) {
        alert('Bitte aktiviere "Als wiederkehrendes Event konfigurieren" um eine Vorschau zu generieren.');
        return;
    }

    const event = buildEventObject();
    if (!event) return;

    const instances = generateRecurringInstances(event, 10);
    const previewContainer = document.getElementById('preview-container');
    const previewOutput = document.getElementById('preview-output');
    
    previewOutput.innerHTML = instances.map((inst, idx) => `
        <div class="preview-date-item ${inst.type}">
            ${inst.type === 'addition' ? '‚≠ê' : inst.type === 'exception' ? '‚ùå' : 'üìå'} 
            ${idx + 1}. ${new Date(inst.date).toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' })}
            ${inst.type === 'addition' ? ' (ZUSATZTERMIN)' : inst.type === 'exception' ? ' (AUSNAHME)' : ''}
        </div>
    `).join('');
    
    previewContainer.style.display = 'block';
}

function buildEventObject() {
    const title = document.getElementById('new-title').value;
    const date = document.getElementById('new-date').value;
    const startTime = document.getElementById('new-start-time').value;
    const endTime = document.getElementById('new-end-time').value;
    const location = document.getElementById('new-location').value;
    const category = document.getElementById('new-category').value;
    const description = document.getElementById('new-description').value;
    
    if (!title || !date || !location) {
        alert('Bitte f√ºlle mindestens Titel, Datum und Ort aus.');
        return null;
    }

    const event = {
        title,
        date,
        startTime,
        endTime,
        location,
        category,
        description,
        recurring: null
    };

    const recurringEnabled = document.getElementById('new-recurring-enabled').checked;
    if (recurringEnabled) {
        const frequency = document.getElementById('new-recurring-frequency').value;
        const interval = parseInt(document.getElementById('new-recurring-interval').value) || 1;
        const endDate = document.getElementById('new-recurring-end-date').value || null;
        const bySetPos = document.getElementById('new-recurring-by-set-pos').value;
        
        // Wochentage sammeln
        const byDay = [];
        document.querySelectorAll('#by-day-section input[type="checkbox"]:checked').forEach(cb => {
            byDay.push(cb.value);
        });

        event.recurring = {
            enabled: true,
            frequency,
            interval,
            by_day: byDay.length > 0 ? byDay : null,
            by_set_pos: bySetPos ? parseInt(bySetPos) : null,
            start_date: date,
            end_date: endDate,
            exceptions: exceptionsData.length > 0 ? [...exceptionsData] : null,
            additions: additionsData.length > 0 ? [...additionsData] : null
        };

        // Validierung
        if ((frequency === 'weekly' || frequency === 'monthly') && (!byDay || byDay.length === 0)) {
            alert('Bitte w√§hle mindestens einen Wochentag aus.');
            return null;
        }
        if (frequency === 'monthly' && bySetPos && !byDay) {
            alert('by_set_pos erfordert die Auswahl von Wochentagen (by_day).');
            return null;
        }
    }

    return event;
}

function generateMarkdown() {
    const event = buildEventObject();
    if (!event) return;

    // Filename generieren
    const slug = event.title.toLowerCase()
        .replace(/√§/g, 'ae').replace(/√∂/g, 'oe').replace(/√º/g, 'ue').replace(/√ü/g, 'ss')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    const filename = `${event.date}-${slug}.md`;

    // Markdown generieren
    let markdown = `---\nlayout: event-detail\ntitle: "${event.title}"\n`;
    markdown += `date: ${event.date}\n`;
    if (event.startTime) markdown += `start_time: "${event.startTime}"\n`;
    if (event.endTime) markdown += `end_time: "${event.endTime}"\n`;
    markdown += `location: "${event.location}"\n`;
    if (event.category) markdown += `category: "${event.category}"\n`;
    markdown += `status: "Entwurf"\n`;
    if (event.description) markdown += `description: "${event.description}"\n`;

    if (event.recurring && event.recurring.enabled) {
        markdown += `recurring:\n`;
        markdown += `  enabled: true\n`;
        markdown += `  frequency: "${event.recurring.frequency}"\n`;
        markdown += `  interval: ${event.recurring.interval}\n`;
        if (event.recurring.by_day && event.recurring.by_day.length > 0) {
            markdown += `  by_day: [${event.recurring.by_day.map(d => `"${d}"`).join(', ')}]\n`;
        }
        if (event.recurring.by_set_pos) {
            markdown += `  by_set_pos: ${event.recurring.by_set_pos}\n`;
        }
        markdown += `  start_date: "${event.recurring.start_date}"\n`;
        markdown += `  end_date: ${event.recurring.end_date ? `"${event.recurring.end_date}"` : 'null'}\n`;
        if (event.recurring.exceptions && event.recurring.exceptions.length > 0) {
            markdown += `  exceptions:\n`;
            event.recurring.exceptions.forEach(exc => {
                markdown += `    - "${exc}"\n`;
            });
        }
        if (event.recurring.additions && event.recurring.additions.length > 0) {
            markdown += `  additions:\n`;
            event.recurring.additions.forEach(add => {
                markdown += `    - "${add}"\n`;
            });
        }
    }

    markdown += `---\n\n`;
    if (event.description) {
        markdown += `${event.description}\n\n`;
    }
    markdown += `<!-- Weitere Details hier -->\n`;

    // Anzeigen
    document.getElementById('markdown-code').value = markdown;
    document.getElementById('markdown-output').style.display = 'block';
    document.getElementById('markdown-output').scrollIntoView({ behavior: 'smooth' });

    alert(`‚úÖ Markdown-Code generiert!\n\nDateiname: ${filename}\n\nScrolle nach unten zum Code.`);
}

function copyMarkdown() {
    const textarea = document.getElementById('markdown-code');
    textarea.select();
    document.execCommand('copy');
    alert('‚úÖ Markdown-Code in Zwischenablage kopiert!');
}

function resetForm() {
    if (!confirm('Formular wirklich zur√ºcksetzen? Alle Eingaben gehen verloren.')) {
        return;
    }
    document.getElementById('new-title').value = '';
    document.getElementById('new-date').value = '';
    document.getElementById('new-start-time').value = '';
    document.getElementById('new-end-time').value = '';
    document.getElementById('new-location').value = '';
    document.getElementById('new-category').value = '';
    document.getElementById('new-description').value = '';
    document.getElementById('new-recurring-enabled').checked = false;
    document.getElementById('recurring-options').style.display = 'none';
    document.getElementById('new-recurring-frequency').value = 'daily';
    document.getElementById('new-recurring-interval').value = '1';
    document.getElementById('new-recurring-end-date').value = '';
    document.getElementById('new-recurring-by-set-pos').value = '';
    document.querySelectorAll('#by-day-section input[type="checkbox"]').forEach(cb => cb.checked = false);
    exceptionsData = [];
    additionsData = [];
    renderDateList('exceptions-list', [], 'removeException');
    renderDateList('additions-list', [], 'removeAddition');
    document.getElementById('markdown-output').style.display = 'none';
    document.getElementById('preview-container').style.display = 'none';
}
</script>
